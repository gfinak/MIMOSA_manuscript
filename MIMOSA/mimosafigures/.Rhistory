colnames(newframe)<-expected
C<-cbind(C[,1:2],newframe)
CC<-list(n.unstim=subset(C,Stim.Condition%in%"Unstim")[,-c(1:2)],n.stim=subset(C,Stim.Condition%in%"Stim")[,-c(1:2)])
foo<-lapply(CC,function(x)prop.table(as.matrix(x),1))
psum<-mean(rowSums(foo[[1]][,2:4])-rowSums(foo[[2]][,2:4]))
pij<-colMeans(foo[[1]][,2:4]-foo[[2]][,2:4])
res<-c(psum,pij)
res
})
genes<-combn(colnames(melted)[6:101],2)[,which(abs(interact.scan[1,])<0.01&abs(interact.scan[4,])>0.3)]
interact.scan[,which(abs(interact.scan[1,])<0.01&abs(interact.scan[4,])>0.3)]
ggg<-genes[,6]
g1<-ggg[1];g2<-ggg[2] #CCR7 and GZMK
g1<-"CCR7";g2<-"GZMK"
gg<-paste(g1,g2,sep=":")
bar<-data.frame(melted[,c("group","Stim.Condition",g1,g2)])
bar$foo<-factor(bar[,c(g1)]):factor(bar[,c(g2)])
setnames(bar,"foo",gg)
C<-cast(melt(bar,id=c("group","Stim.Condition"),measure=c(gg)),group+Stim.Condition~value,fun.aggregate=function(x)length(x))
CC<-list(n.unstim=subset(C,Stim.Condition%in%"Unstim")[,-c(1:2)],n.stim=subset(C,Stim.Condition%in%"Stim")[,-c(1:2)])
toplot<-data.frame(rbind(data.frame(CC$n.stim),data.frame(CC$n.unstim)),stim=c(rep("Stim",nrow(CC$n.stim)),rep("Unstim",nrow(CC$n.unstim))))
toplot$id<-rep(unlist(lapply(strsplit(as.character(subset(C,Stim.Condition%in%"Unstim")[,1]),":"),function(x)x[1]),use.names=FALSE),2)
colnames(toplot)[1:4]<-gsub("X","",paste(g1,g2,colnames(toplot)[1:4],sep=":"))
toplot<-melt(toplot,id=c("id","stim"))
ggplot(toplot)+geom_raster(aes(x=variable,y=id,fill=value))+theme_bw()+theme(axis.text.x=element_text(angle=90))+facet_wrap(~stim)+scale_fill_continuous(na.value="gray",breaks=round(seq(0,96,l=10)))
DD<-CC
DD[[1]]<-cbind(CC[[1]][,1],rowSums(CC[[1]][,2:4]))
DD[[2]]<-cbind(CC[[2]][,1],rowSums(CC[[2]][,2:4]))
toplot2<-data.frame(rbind(data.frame(DD$n.stim),data.frame(DD$n.unstim)),stim=c(rep("Stim",nrow(DD$n.stim)),rep("Unstim",nrow(DD$n.unstim))))
toplot2$id<-rep(unlist(lapply(strsplit(as.character(subset(C,Stim.Condition%in%"Unstim")[,1]),":"),function(x)x[1]),use.names=FALSE),2)
colnames(toplot2)[1:2]<-gsub("X","",paste(g1,g2,colnames(toplot2)[1:2],sep=":"))
toplot2<-melt(toplot2,id=c("id","stim"))
ggplot(toplot2)+geom_raster(aes(x=variable,y=id,fill=value))+theme_bw()+theme(axis.text.x=element_text(angle=90))+facet_wrap(~stim)+scale_fill_continuous(na.value="gray",breaks=round(seq(0,96,l=10)))
sourcr("./compile.R")
source("./compile.R")
list.files()
set.seed(101)
as<-c(1,1,1,1,3.5,1,1)
au<-c(1,1,1,1,1,3.5,1)
as<-c(1000-sum(as),as)*100
au<-c(1000-sum(au),au)*100
if(!file.exists("mvsims.rds")){
mdsim<-replicate(10,{
simd<-MIMOSA:::simMD(alpha.s=as,alpha.u=au,N=100,w=0.5,n=3.5,alternative="not equal")
foo<-.fitMCMC(simd,inits=MIMOSA:::MDMix(simd,initonly=TRUE))
foo
})
saveRDS(simd,file="mvsims.rds")
}else{
mdsim<-readRDS("mvsims.rds")
}
mdsim
length(mdsim)
dim(mdsim)
fisher.p<-vector('list',ncol(mdsim))
ncol(mdsim)
mdsim<-replicate(10,{
simd<-MIMOSA:::simMD(alpha.s=as,alpha.u=au,N=100,w=0.5,n=3.5,alternative="not equal")
foo<-.fitMCMC(simd,inits=MIMOSA:::MDMix(simd,initonly=TRUE))
foo
})
mdsim
mdsim<-sapply(1:10,function(i){
simd<-MIMOSA:::simMD(alpha.s=as,alpha.u=au,N=100,w=0.5,n=3.5,alternative="not equal")
foo<-.fitMCMC(simd,inits=MIMOSA:::MDMix(simd,initonly=TRUE))
foo
})
mdsim
saveRDS(simd,file="mvsims.rds")
saveRDS(mdsim,file="mvsims.rds")
fisher.p<-vector('list',ncol(mdsim))
for(i in 1:ncol(mdsim)){
fisher.p[[i]]<-rep(NA,nrow(mdsim[,i]$n.stim))
for(j in 1:nrow(mdsim[,i]$n.stim)){
fisher.p[[i]][j]<-  fisher.test(cbind(mdsim[,i]$n.stim[j,],mdsim[,i]$n.unstim[j,]),alternative="two.sided",simulate.p.value=TRUE)$p
}
}
FDR<-function(x,truth){
o<-order(x,decreasing=FALSE)
cbind(tpr=cumsum(truth[o])/sum(truth),fpr=cumsum(!truth[o])/sum(!truth))
}
fisher.p.adj<-lapply(fisher.p,function(x)p.adjust(x,"fdr"))
fisher.roc<-do.call(rbind,by(cbind(do.call(rbind,lapply(fisher.p.adj,function(i)FDR(i,gl(2,50)==2)))),rep(gl(100,1),10),function(x)colMeans(x)))
mimosa.adj<-lapply(1:ncol(mdsim),function(i)MIMOSA:::fdr(mdsim[,i]$z))
MIMOSA.roc<-do.call(rbind,by(do.call(rbind,lapply(mimosa.adj,function(i)FDR(i,gl(2,50)==2))),rep(gl(100,1),10),function(x)colMeans(x)))
foo<-data.frame(as.data.frame(rbind(fisher.roc,MIMOSA.roc)),Method=gl(2,100,labels=c("Fisher","MIMOSA")))
sz<-element_text(size=18)
ggplot(foo)+geom_line(aes(x=fpr,y=tpr,col=Method))+scale_y_continuous("TPR")+scale_x_continuous("FPR")+theme_bw()+theme(axis.title.x=sz,axis.title.y=sz,axis.text.x=sz,axis.text.y=sz)
source("./compile.R")
source("utility.R")
setup()
hvtndata<-readHVTNData()
hvtndata<-processHVTNData(hvtndata)
hvtndata<-constructEset(hvtndata)
hvtn.result.EM<-MIMOSA(NSUB+CYTNUM~ASSAYID+VISITNO+PTID+RX_CODE+RefTreat|TCELLSUB+ANTIGEN+CYTOKINE,hvtndata,ref=RefTreat%in%"Reference"&ANTIGEN%in%"ENV-1-PTEG",subset=RefTreat%in%"Treatment"&ANTIGEN%in%"ENV-1-PTEG",method="EM",run.parallel=TRUE)
hvtn.result.mcmc<-MIMOSA(NSUB+CYTNUM~ASSAYID+VISITNO+PTID+RX_CODE+RefTreat|TCELLSUB+ANTIGEN+CYTOKINE,hvtndata,ref=RefTreat%in%"Reference"&ANTIGEN%in%"ENV-1-PTEG",subset=RefTreat%in%"Treatment"&ANTIGEN%in%"ENV-1-PTEG",method="mcmc",run.parallel=TRUE,pXi=0.1,getP=TRUE)
hvtn.summary.EM<-summarizeMIMOSAFit(hvtn.result.EM)
hvtn.summary.EM<-subset(hvtn.summary.EM,Method%in%"EM")
hvtn.summary.mcmc<-summarizeMIMOSAFit(hvtn.result.mcmc)
hvtn.summary.mcmc<-FisherFromSummary(hvtn.summary.mcmc)
hvtn.summary.mcmc<-LRT(hvtn.summary.mcmc)
hvtn.summary.mcmc<-FoldChangeRank(hvtn.summary.mcmc)
#'Compute ROC and FDR curves and calculate the AUC.
#'+ cache=TRUE
ROC<-ComputeROCs(hvtn.summary.mcmc,hvtn.summary.EM)
FDR<-ComputeFDRs(hvtn.summary.mcmc,hvtn.summary.EM)
AUC<-ComputeAUCs(ROC)
#' FDR and ROC plots
#' --------
#' We see that MIMOSA performs as well or better than competing methods. The MCMC routine performs better than the EM routine for some data.
#+ cache=TRUE,fig.width=10,fig.height=8,fig.cap='The TNF expressing cytokine specific cells have high background as evidenced by the poor performance of all methods fit to TNF+ subsets of cells, with the exception of the triple-positive cell subset. As the number of simultaneously expressed cytokines being examined increases, the background decreases.'
ROC$Method<-relevel(ROC$Method,"MIMOSA (EM)")
levs <-
c("IFN-IL2-TNF+", "IFN-IL2+TNF-", "IFN-IL2+TNF+", "IFN+IL2-TNF-",
"IFN+IL2-TNF+", "IFN+IL2+TNF-", "IFN+IL2+TNF+", "IFNg+", "IFNg+IL2+",
"IFNg+TNF+", "IL2+", "IL2-IFNg+", "IL2+ OR IFNg+", "IL2+IFNg-",
"IL2+IFNg+", "IL2+TNF+", "TNF+")
ROC$CYTOKINE<-factor(ROC$CYTOKINE,labels=levs)
AUC$CYTOKINE<-factor(AUC$CYTOKINE,labels=levs)
rocplots<-ggplot(subset(ROC,TCELLSUB%in%"cd3+/cd4+"))+geom_line(aes(x=FPR,y=TPR,color=Method))+theme_bw()+facet_wrap(~CYTOKINE)+geom_text(aes(x=x,y=y,label=sprintf("AUC=%s",signif(AUC,2)),col=Method),size=3,data=AUC,show_guide=FALSE)+theme(axis.text.x=element_text(angle=90,hjust=1))
#+ fig.width=10,fig.height=8,fig.cap='The FDR is well controlled for cytokine subsets with low background. The TNF expressing subsets have high background and consequently positive assay results in the "Visit 2" samples, which are labelled as "true negatives" in this scheme. The result is observed as a large observed false discovery rate for all methods.'
FDR$Method<-relevel(FDR$Method,"MIMOSA (EM)")
levs<-levels(FDR$CYTOKINE)
levs <-
c("IFN-IL2-TNF+", "IFN-IL2+TNF-", "IFN-IL2+TNF+", "IFN+IL2-TNF-",
"IFN+IL2-TNF+", "IFN+IL2+TNF-", "IFN+IL2+TNF+", "IFNg+", "IFNg+IL2+",
"IFNg+TNF+", "IL2+", "IL2-IFNg+", "IL2+ OR IFNg+", "IL2+IFNg-",
"IL2+IFNg+", "IL2+TNF+", "TNF+")
FDR$CYTOKINE<-factor(FDR$CYTOKINE,labels=levs)
fdrplots<-ggplot(subset(FDR,TCELLSUB%in%c("cd3+/cd4+")))+geom_line(aes(y=true.fdr,x=fdr,color=Method))+geom_abline(1,lty=3)+theme_bw()+scale_x_continuous(name="Nominal FDR")+scale_y_continuous(name="Observed FDR")+facet_wrap(~CYTOKINE)+theme(axis.text.x=element_text(angle=90,hjust=1))
hvtn.summary.EM<-summarizeMIMOSAFit(hvtn.result.EM)
hvtn.result.EM
hvtn.result.EM<-MIMOSA(NSUB+CYTNUM~ASSAYID+VISITNO+PTID+RX_CODE+RefTreat|TCELLSUB+ANTIGEN+CYTOKINE,hvtndata,ref=RefTreat%in%"Reference"&ANTIGEN%in%"ENV-1-PTEG",subset=RefTreat%in%"Treatment"&ANTIGEN%in%"ENV-1-PTEG",method="EM",run.parallel=TRUE)
hvtn.summary.EM<-summarizeMIMOSAFit(hvtn.result.EM)
hvtn.summary.EM<-subset(hvtn.summary.EM,Method%in%"EM")
hvtn.summary.mcmc<-summarizeMIMOSAFit(hvtn.result.mcmc)
hvtn.summary.mcmc<-FisherFromSummary(hvtn.summary.mcmc)
hvtn.summary.mcmc<-LRT(hvtn.summary.mcmc)
hvtn.summary.mcmc<-FoldChangeRank(hvtn.summary.mcmc)
#'Compute ROC and FDR curves and calculate the AUC.
#'+ cache=TRUE
ROC<-ComputeROCs(hvtn.summary.mcmc,hvtn.summary.EM)
FDR<-ComputeFDRs(hvtn.summary.mcmc,hvtn.summary.EM)
AUC<-ComputeAUCs(ROC)
#' FDR and ROC plots
#' --------
#' We see that MIMOSA performs as well or better than competing methods. The MCMC routine performs better than the EM routine for some data.
#+ cache=TRUE,fig.width=10,fig.height=8,fig.cap='The TNF expressing cytokine specific cells have high background as evidenced by the poor performance of all methods fit to TNF+ subsets of cells, with the exception of the triple-positive cell subset. As the number of simultaneously expressed cytokines being examined increases, the background decreases.'
ROC$Method<-relevel(ROC$Method,"MIMOSA (EM)")
levs <-
c("IFN-IL2-TNF+", "IFN-IL2+TNF-", "IFN-IL2+TNF+", "IFN+IL2-TNF-",
"IFN+IL2-TNF+", "IFN+IL2+TNF-", "IFN+IL2+TNF+", "IFNg+", "IFNg+IL2+",
"IFNg+TNF+", "IL2+", "IL2-IFNg+", "IL2+ OR IFNg+", "IL2+IFNg-",
"IL2+IFNg+", "IL2+TNF+", "TNF+")
ROC$CYTOKINE<-factor(ROC$CYTOKINE,labels=levs)
AUC$CYTOKINE<-factor(AUC$CYTOKINE,labels=levs)
rocplots<-ggplot(subset(ROC,TCELLSUB%in%"cd3+/cd4+"))+geom_line(aes(x=FPR,y=TPR,color=Method))+theme_bw()+facet_wrap(~CYTOKINE)+geom_text(aes(x=x,y=y,label=sprintf("AUC=%s",signif(AUC,2)),col=Method),size=3,data=AUC,show_guide=FALSE)+theme(axis.text.x=element_text(angle=90,hjust=1))
#+ fig.width=10,fig.height=8,fig.cap='The FDR is well controlled for cytokine subsets with low background. The TNF expressing subsets have high background and consequently positive assay results in the "Visit 2" samples, which are labelled as "true negatives" in this scheme. The result is observed as a large observed false discovery rate for all methods.'
FDR$Method<-relevel(FDR$Method,"MIMOSA (EM)")
levs<-levels(FDR$CYTOKINE)
levs <-
c("IFN-IL2-TNF+", "IFN-IL2+TNF-", "IFN-IL2+TNF+", "IFN+IL2-TNF-",
"IFN+IL2-TNF+", "IFN+IL2+TNF-", "IFN+IL2+TNF+", "IFNg+", "IFNg+IL2+",
"IFNg+TNF+", "IL2+", "IL2-IFNg+", "IL2+ OR IFNg+", "IL2+IFNg-",
"IL2+IFNg+", "IL2+TNF+", "TNF+")
FDR$CYTOKINE<-factor(FDR$CYTOKINE,labels=levs)
fdrplots<-ggplot(subset(FDR,TCELLSUB%in%c("cd3+/cd4+")))+geom_line(aes(y=true.fdr,x=fdr,color=Method))+geom_abline(1,lty=3)+theme_bw()+scale_x_continuous(name="Nominal FDR")+scale_y_continuous(name="Observed FDR")+facet_wrap(~CYTOKINE)+theme(axis.text.x=element_text(angle=90,hjust=1))
rocplots
fdrplots
saveRDS(hvtn.result.EM,file="hvtnEMfit.rds")
saveRDS(hvtn.result.mcmc,file="hvtnMCMCfit.rds")
df<-data.frame(tcellsub="CD4",treatment=gl(2,224/2,labels=c("stim","unstim")),melt(data.frame(stim=prop.table(as.matrix(hvtn.result.mcmc[[1]]@result@n.stim),1)[,2],unstim=prop.table(as.matrix(hvtn.result.mcmc[[1]]@result@n.unstim),1)[,2])[,2]))
df<-rbind(df,data.frame(tcellsub="CD8",treatment=gl(2,224/2,labels=c("stim","unstim")),proportion=melt(data.frame(stim=prop.table(as.matrix(hvtn.result.mcmc[[30]]@result@n.stim),1)[,2],unstim=prop.table(as.matrix(hvtn.result.mcmc[[30]]@result@n.unstim),1)[,2])[,2])))
ggplot(df)+geom_density(aes(x=value,fill=tcellsub),alpha=0.75,position="identity")+theme_bw()+scale_x_continuous(name="Cell Count",labels=scientific)+facet_wrap(~tcellsub,scales="free")
df<-data.frame(tcellsub="CD4",treatment=gl(2,224/2,labels=c("stim","unstim")),melt(data.frame(stim=prop.table(as.matrix(hvtn.result.mcmc[[1]]@result@n.stim),1)[,2],unstim=prop.table(as.matrix(hvtn.result.mcmc[[1]]@result@n.unstim),1)[,2])[,2]))
hvtn.result.mcmc[[1]]@result@n.stim
dim(hvtn.result.mcmc[[1]]@result@n.stim)
dim(hvtn.result.mcmc[[2]]@result@n.stim)
df<-data.frame(tcellsub="CD4",treatment=gl(2,,nrow(hvtn.result.mcmc[[30]]@result@n.stim)/2,labels=c("stim","unstim")),melt(data.frame(stim=prop.table(as.matrix(hvtn.result.mcmc[[1]]@result@n.stim),1)[,2],unstim=prop.table(as.matrix(hvtn.result.mcmc[[1]]@result@n.unstim),1)[,2])[,2]))
df<-rbind(df,data.frame(tcellsub="CD8",treatment=gl(2,nrow(hvtn.result.mcmc[[30]]@result@n.unstim)/2,labels=c("stim","unstim")),proportion=melt(data.frame(stim=prop.table(as.matrix(hvtn.result.mcmc[[30]]@result@n.stim),1)[,2],unstim=prop.table(as.matrix(hvtn.result.mcmc[[30]]@result@n.unstim),1)[,2])[,2])))
df<-data.frame(tcellsub="CD4",treatment=gl(2,nrow(hvtn.result.mcmc[[1]]@result@n.stim)/2,labels=c("stim","unstim")),melt(data.frame(stim=prop.table(as.matrix(hvtn.result.mcmc[[1]]@result@n.stim),1)[,2],unstim=prop.table(as.matrix(hvtn.result.mcmc[[1]]@result@n.unstim),1)[,2])[,2]))
df<-rbind(df,data.frame(tcellsub="CD8",treatment=gl(2,nrow(hvtn.result.mcmc[[30]]@result@n.unstim)/2,labels=c("stim","unstim")),proportion=melt(data.frame(stim=prop.table(as.matrix(hvtn.result.mcmc[[30]]@result@n.stim),1)[,2],unstim=prop.table(as.matrix(hvtn.result.mcmc[[30]]@result@n.unstim),1)[,2])[,2])))
ggplot(df)+geom_density(aes(x=value,fill=tcellsub),alpha=0.75,position="identity")+theme_bw()+scale_x_continuous(name="Cell Count",labels=scientific)+facet_wrap(~tcellsub,scales="free")
require(labels)
require(label)
require(scales)
ggplot(df)+geom_density(aes(x=value,fill=tcellsub),alpha=0.75,position="identity")+theme_bw()+scale_x_continuous(name="Cell Count",labels=scientific)+facet_wrap(~tcellsub,scales="free")
head(df)
pData(hvtn.result.mcmc[[30]])
colnames(pData(hvtn.result.mcmc[[30]]))
pData(hvtn.result.mcmc[[30]])$RX_CODE
table(pData(hvtn.result.mcmc[[30]])$RX_CODE)
"foo \ bar"
print("foo \ bar")
print("foo \\ bar")
print("foo \\\ bar")
print("foo \\ bar")
print("foo \ bar")
print("foo \\\\ bar")
cat("foo \\\\ bar")
cat("foo \\\ bar")
heatmap.2((((adj.fisher))*S)[apply(adj.fisher,1,function(x)sum(x<0.1)>1),],col=colorpanel(n=100,high="green",low="red",mid="white"),margins=c(6,5),hclustfun=function(x)hclust(x,method="complete"),trace="none",symbreaks=TRUE,ColSideColors=c("red","orange","yellow","green")[as.numeric(stim)],Colv=TRUE,denscol="black")
fluidigm<-readFluidigmData()
fluidigm<-processFluidigmData()
fl.bystim<-lapply(fluidigm,exprs)
cd.bystim<-lapply(fluidigm,cData)
fl<-lapply(names(fl.bystim),function(n){
m<-melt(cbind(fl.bystim[[n]],cd.bystim[[n]]),id=c("Stim.Agent","Stim.Condition","Time.of.Stim","Sero.Status","Patient.ID","Chip.Number","Well","Number.of.Cells"))
ddply(m,.(Stim.Condition,Patient.ID,variable),summarize,N=length(value),n=sum(value>0))
})
fl<-lapply(fl,function(x)setnames(x,"variable","Gene"))
Esets.fluidigm<-lapply(fl,function(x)ConstructMIMOSAExpressionSet(x,reference=Stim.Condition%in%"Unstim",measure.columns=c("N","n"),other.annotations=c("Gene","Patient.ID","Stim.Condition"),default.cast.formula=component~Patient.ID+Gene,.variables=.(Patient.ID,Gene),featureCols=1,ref.append.replace="_REF"))
nms<-names(fl.bystim)
Esets.fluidigm<-lapply(1:length(Esets.fluidigm),function(x){pData(Esets.fluidigm[[x]])<-cbind(pData(Esets.fluidigm[[x]]),Stim=nms[x]);Esets.fluidigm[[x]]})
Eset.combined<-combine(Esets.fluidigm[[1]],Esets.fluidigm[[2]],Esets.fluidigm[[3]],Esets.fluidigm[[4]])
fluidigm.fits.by.stim.allgenes<-readRDS("fluidigm.fits.by.stim.allgenes.rds")
fluidigm.fits.by.stim.bygene<-readRDS("fluidigm.fits.by.stim.bygene.rds")
foo<-do.call(rbind,lapply(fluidigm.fits.by.stim.allgenes[[1]],function(x)x@z[,2]))
props<-do.call(rbind,lapply(fluidigm.fits.by.stim.allgenes[[1]],function(x)do.call(c,lapply(x@result@p,function(x)-diff(x[,2])))))
S<-sign(props)
S[S==0]<-1
colnames(S)<-pData(fluidigm.fits.by.stim.allgenes[[1]][[1]])[,c("Patient.ID")]
stim<-pData(fluidigm.fits.by.stim.allgenes[[1]][[1]])$Stim
rownames(S)<-do.call(rbind,lapply(fluidigm.fits.by.stim.allgenes[[1]],function(x)as.character(unique(pData(x)$Gene))))
heatmap.2((S*(foo))[apply(foo,1,function(x)sum(x>0.6)>=1),],col=colorpanel(n=10,high="green",low="red",mid="white"),margins=c(6,5),cexRow=0.5,hclustfun=function(x)hclust(x,method="complete"),trace="none",symbreaks=TRUE,ColSideColors=c("red","orange","yellow","green")[as.numeric(stim)],Colv=TRUE,main="signed Posterior Probabilities\n(fit by gene, all stimulations)")
heatmap.2((S*(foo))[apply(foo,1,function(x)sum(x>0.6)>=1),],col=colorpanel(n=100,high="green",low="red",mid="white"),margins=c(6,5),cexRow=0.75,hclustfun=function(x)hclust(x,method="complete"),trace="none",symbreaks=TRUE,ColSideColors=c("red","orange","yellow","green")[as.numeric(stim)],Colv=TRUE,denscol="black")
foo
dim(foo)
apply(foo,2,function(x)MIMOSA:::fdr(cbind(1-x,x)))
foo2<-apply(foo,2,function(x)MIMOSA:::fdr(cbind(1-x,x)))
foo2<-apply(foo,2,function(x)MIMOSA:::fdr(cbind(1-x,x)))
heatmap.2((S*(foo))[apply(foo2,1,function(x)sum(x>0.6)>=1),],col=colorpanel(n=100,high="green",low="red",mid="white"),margins=c(6,5),cexRow=0.75,hclustfun=function(x)hclust(x,method="complete"),trace="none",symbreaks=TRUE,ColSideColors=c("red","orange","yellow","green")[as.numeric(stim)],Colv=TRUE,denscol="black")
heatmap.2((S*(foo))[apply(foo2,1,function(x)sum(x<0.1)>=1),],col=colorpanel(n=100,high="green",low="red",mid="white"),margins=c(6,5),cexRow=0.75,hclustfun=function(x)hclust(x,method="complete"),trace="none",symbreaks=TRUE,ColSideColors=c("red","orange","yellow","green")[as.numeric(stim)],Colv=TRUE,denscol="black")
foo2<-apply(foo,2,function(x)MIMOSA:::fdr(cbind(1-x,x)))
pdf(file="/Users/gfinak/Documents/manuscripts/MIMOSA_Paper/Figures/FluidigmCombinedFit.pdf")
heatmap.2((S*(foo))[apply(foo2,1,function(x)sum(x<0.1)>=1),],col=colorpanel(n=100,high="green",low="red",mid="white"),margins=c(6,5),cexRow=0.75,hclustfun=function(x)hclust(x,method="complete"),trace="none",symbreaks=TRUE,ColSideColors=c("red","orange","yellow","green")[as.numeric(stim)],Colv=TRUE,denscol="black")
dev.off()
colnames(props)<-colnames(S)
rownames(props)<-rownames(S)
heatmap.2(S*sqrt(abs(props)),col=colorpanel(n=10,high="green",low="red",mid="white"),margins=c(6,5),cexRow=0.5,hclustfun=function(x)hclust(x,method="complete"),trace="none",symbreaks=TRUE,ColSideColors=c("red","orange","yellow","green")[as.numeric(stim)],Colv=TRUE,main="Posterior Differences in Proportions\n(fit by gene all stimulations)")
foo<-do.call(cbind,lapply(fluidigm.fits.by.stim.bygene,function(x)do.call(rbind,lapply(x,function(x)x@z[,2]))))
props<-do.call(cbind,lapply(fluidigm.fits.by.stim.bygene,function(x)do.call(rbind,lapply(x,function(x)do.call(c,lapply(x@result@p,function(x)-diff(x[,2])))))))
S<-sign(props)
colnames(S)<-do.call(c,lapply(fluidigm.fits.by.stim.bygene,function(x)as.character(pData(x[[1]])[,c("Patient.ID")])))
S[S==0]<-1
stim<-as.numeric(factor(do.call(c,lapply(fluidigm.fits.by.stim.bygene,function(x)as.character(pData(x[[1]])$Stim)))))
colnames(S)<-do.call(c,lapply(fluidigm.fits.by.stim.bygene,function(x)as.character(pData(x[[1]])$Patient.ID)))
rownames(S)<-do.call(cbind,lapply(fluidigm.fits.by.stim.bygene[[1]],function(x)as.character(unique(pData(x)$Gene))))
h<-heatmap.2((S*foo)[apply(foo,1,function(x)sum(x>.6)>=1),],col=colorpanel(n=10,high="green",low="red",mid="white"),margins=c(6,5),cexRow=0.5,hclustfun=function(x)hclust(x,method="complete"),trace="none",symbreaks=TRUE,ColSideColors=c("red","orange","yellow","green")[as.numeric(stim)],main="Signed Posterior Probabilities\n(fit by gene and stimulation).")
hmaporder<-h$colInd
geneinds<-apply(foo,1,function(x)sum(x>.6)>=1)
foo2<-apply(foo,2,function(x)MIMOSA:::fdr(cbind(1-x,x)))
foo2<-apply(foo,2,function(x)MIMOSA:::fdr(cbind(1-x,x)))
heatmap.2((S*(foo))[apply(foo2,1,function(x)sum(x<0.1)>=1),],col=colorpanel(n=100,high="green",low="red",mid="white"),margins=c(6,5),cexRow=0.75,hclustfun=function(x)hclust(x,method="complete"),trace="none",symbreaks=TRUE,ColSideColors=c("red","orange","yellow","green")[as.numeric(stim)],Colv=TRUE,denscol="black")
pdf(file="/Users/gfinak/Documents/manuscripts/MIMOSA_Paper/Figures/Fluidigm_plot1.pdf")
heatmap.2((S*(foo))[apply(foo2,1,function(x)sum(x<0.1)>=1),],col=colorpanel(n=100,high="green",low="red",mid="white"),margins=c(6,5),cexRow=0.75,hclustfun=function(x)hclust(x,method="complete"),trace="none",symbreaks=TRUE,ColSideColors=c("red","orange","yellow","green")[as.numeric(stim)],Colv=TRUE,denscol="black")
dev.off()
colnames(props)<-colnames(S)
rownames(props)<-rownames(S)
heatmap.2(sqrt(abs(props))*S,col=colorpanel(n=10,high="green",low="red",mid="white"),margins=c(6,5),cexRow=0.5,hclustfun=function(x)hclust(x,method="complete"),trace="none",symbreaks=TRUE,ColSideColors=c("red","orange","yellow","green")[as.numeric(stim)],Colv=TRUE,main="Posterior differences in proportions\n(fit by gene and stimulations)")
fisher<-do.call(rbind,lapply(fluidigm.fits.by.stim.allgenes[[1]],function(x){
p<-vector('numeric',nrow(x@result@n.stim))
for(i in 1:nrow(x@result@n.stim)){
p[i]<-fisher.test(as.matrix(rbind(x@result@n.stim[i,],x@result@n.unstim[i,])),alternative="two.sided")$p.value
}
p
}))
adj.fisher<-matrix(p.adjust(fisher,"fdr"),nrow=96)
S<-sign(lapply(fluidigm.fits.by.stim.allgenes,function(x)do.call(rbind,lapply(x,function(x)(prop.table(as.matrix(x@result@n.stim),1)-prop.table(as.matrix(x@result@n.unstim),1))[,2])))[[1]])
S[S==0]<-1
colnames(fisher)<-gsub("_B3GAT1_Treatment","",colnames(S))
rownames(fisher)<-do.call(rbind,lapply(fluidigm.fits.by.stim.allgenes[[1]],function(x)as.character(unique(pData(x)$Gene))))
stim<-pData(fluidigm.fits.by.stim.allgenes[[1]][[1]])$Stim
heatmap.2(fisher*S,col=colorpanel(n=10,high="green",low="red",mid="white"),margins=c(6,5),cexRow=0.5,hclustfun=function(x)hclust(x,method="complete"),trace="none",symbreaks=TRUE,ColSideColors=c("red","orange","yellow","green")[as.numeric(stim)],Colv=TRUE,main="-log10(p-values)\nfrom Fisher's Exact Test")
heatmap.2((((adj.fisher))*S)[apply(adj.fisher,1,function(x)sum(x<0.1)>1),],col=colorpanel(n=100,high="green",low="red",mid="white"),margins=c(6,5),hclustfun=function(x)hclust(x,method="complete"),trace="none",symbreaks=TRUE,ColSideColors=c("red","orange","yellow","green")[as.numeric(stim)],Colv=TRUE,denscol="black")
heatmap.2((((adj.fisher))*S)[apply(adj.fisher,1,function(x)sum(x<0.1)>1),],col=colorpanel(n=100,high="green",low="red",mid="white"),margins=c(6,5),hclustfun=function(x)hclust(x,method="complete"),trace="none",symbreaks=TRUE,ColSideColors=c("red","orange","yellow","green")[as.numeric(stim)],Colv=TRUE,denscol="black")
dim(fisher)
rownames(fisher)<-do.call(rbind,lapply(fluidigm.fits.by.stim.allgenes[[1]],function(x)as.character(unique(pData(x)$Gene))))
stim<-pData(fluidigm.fits.by.stim.allgenes[[1]][[1]])$Stim
heatmap.2(fisher*S,col=colorpanel(n=10,high="green",low="red",mid="white"),margins=c(6,5),cexRow=0.5,hclustfun=function(x)hclust(x,method="complete"),trace="none",symbreaks=TRUE,ColSideColors=c("red","orange","yellow","green")[as.numeric(stim)],Colv=TRUE,main="-log10(p-values)\nfrom Fisher's Exact Test")
colnames(adj.fisher)<-colnames(fisher)
rownames(adj.fisher)<-rownames(fisher)
heatmap.2((((adj.fisher))*S)[apply(adj.fisher,1,function(x)sum(x<0.1)>1),],col=colorpanel(n=100,high="green",low="red",mid="white"),margins=c(6,5),hclustfun=function(x)hclust(x,method="complete"),trace="none",symbreaks=TRUE,ColSideColors=c("red","orange","yellow","green")[as.numeric(stim)],Colv=TRUE,denscol="black")
emprop<-do.call(rbind,lapply(fluidigm.fits.by.stim.allgenes[[1]],function(x){
p<-vector('numeric',nrow(x@result@n.stim))
p<-(prop.table(as.matrix((x@result@n.stim)),1)-prop.table(as.matrix(x@result@n.unstim),1))[,2]
}))
rownames(emprop)<-rownames(fisher)
colnames(emprop)<-colnames(fisher)
heatmap.2(emprop[geneinds,hmaporder],col=colorpanel(n=100,high="green",low="red",mid="white"),margins=c(6,5),Colv=NULL,denscol="black",tracecol="black",symbreaks=TRUE,ColSideColors=c("red","orange","yellow","green")[as.numeric(stim)[hmaporder]])
apply(adj.fisher,1,function(x)sum(x<0.1)>1)
table(apply(adj.fisher,1,function(x)sum(x<0.1)>1))
apply(foo2,1,function(x)sum(x<0.1)>=1)
table(apply(foo2,1,function(x)sum(x<0.1)>=1))
apply(foo2,1,function(x)sum(x<0.1)>=1)
apply(foo2,1,function(x)sum(x<0.1)>=1)
table(apply(adj.fisher,1,function(x)sum(x<0.1)>1))
apply(foo2,1,function(x)sum(x<0.1)>=1)
table(apply(foo2,1,function(x)sum(x<0.1)>=1),(apply(adj.fisher,1,function(x)sum(x<0.1)>1)))
p1<-ggplot(subset(sims$sim.ROC,Num==25000))+geom_line(aes(x=FPR.hat,y=TPR.hat,col=relevel(method,"MIMOSA")),direction="vh",lwd=1.5,alpha=0.8)+theme_bw()+scale_x_continuous("FPR")+scale_y_continuous("TPR")+coord_cartesian(xlim=c(-0.01,1.01),ylim=c(-0.01,1.01))+scale_color_discrete("Method")+facet_wrap(~Num)+theme(strip.text.x=element_text(size=18),axis.title.x=element_text(size=18),axis.title.y=element_text(size=18),axis.text.x=element_text(angle=90))
ggplot(pd)+geom_point(aes(x=effect,y=Prob.resp,color=response))+facet_wrap(TCELLSUB~CYTOKINE,scale="free_x")+theme(axis.text.x=element_text(angle=90))+scale_color_discrete("Response",labels=c("No","Yes"))
pd<-do.call(rbind,lapply(hvtn.result.mcmc,function(x)pData(x)))
pd<-cbind(pd,do.call(rbind,lapply(hvtn.result.mcmc,function(x)data.frame(response=MIMOSA:::fdr(x@z)<0.01,Prob.resp=x@z[,2],effect=do.call(c,lapply(x@result@p,function(x)diff(rev(x[,2]))))))))
ggplot(pd)+geom_point(aes(x=effect,y=Prob.resp,color=response))+facet_wrap(TCELLSUB~CYTOKINE,scale="free_x")+theme(axis.text.x=element_text(angle=90))+scale_color_discrete("Response",labels=c("No","Yes"))
head(pd)
colnames(pd)
ggplot(pd)+geom_point(aes(x=effect,y=Prob.resp,color=response,shape=VISITNO:RX_CODE))+facet_wrap(TCELLSUB~CYTOKINE,scale="free_x")+theme(axis.text.x=element_text(angle=90))+scale_color_discrete("Response",labels=c("No","Yes"))
pd$RX_CODE
pd$RX_CODE%in%c("T1","T2","T3","T4")
pd$VACCINE<-pd$RX_CODE%in%c("T1","T2","T3","T4")
ggplot(pd)+geom_point(aes(x=effect,y=Prob.resp,color=response,shape=VISITNO:RX_CODE))+facet_wrap(TCELLSUB~CYTOKINE,scale="free_x")+theme(axis.text.x=element_text(angle=90))+scale_color_discrete("Response",labels=c("No","Yes"))
ggplot(pd)+geom_point(aes(x=effect,y=Prob.resp,color=response,shape=VISITNO:VACCINE))+facet_wrap(TCELLSUB~CYTOKINE,scale="free_x")+theme(axis.text.x=element_text(angle=90))+scale_color_discrete("Response",labels=c("No","Yes"))
pd$VACCINE<-factor(pd$RX_CODE%in%c("T1","T2","T3","T4"))
ggplot(pd)+geom_point(aes(x=effect,y=Prob.resp,color=response,shape=VISITNO:VACCINE))+facet_wrap(TCELLSUB~CYTOKINE,scale="free_x")+theme(axis.text.x=element_text(angle=90))+scale_color_discrete("Response",labels=c("No","Yes"))
ggplot(subset(pd,TCELLSUB%in%"cd3+/cd4+")+geom_point(aes(x=effect,y=Prob.resp,color=response,shape=VISITNO:VACCINE))+facet_wrap(TCELLSUB~CYTOKINE,scale="free_x")+theme(axis.text.x=element_text(angle=90))+scale_color_discrete("Response",labels=c("No","Yes"))
ggplot(subset(pd,TCELLSUB%in%"cd3+/cd4+"))+geom_point(aes(x=effect,y=Prob.resp,color=response,shape=VISITNO:VACCINE))+facet_wrap(TCELLSUB~CYTOKINE,scale="free_x")+theme(axis.text.x=element_text(angle=90))+scale_color_discrete("Response",labels=c("No","Yes"))
ggplot(subset(pd,TCELLSUB%in%"cd3+/cd4+"))+geom_point(aes(x=effect,y=Prob.resp,color=response,shape=VISITNO:VACCINE))+facet_wrap(TCELLSUB~CYTOKINE,scale="free_x")+theme(axis.text.x=element_text(angle=90))+scale_color_discrete("Response",labels=c("No","Yes"))
ggplot(subset(pd,TCELLSUB%in%"cd3+/cd4+"))+geom_point(aes(x=effect,y=Prob.resp,color=response,shape=VISITNO:VACCINE))+facet_wrap(TCELLSUB~CYTOKINE,scale="free_x")+theme(axis.text.x=element_text(angle=90))+scale_color_discrete("Response",labels=c("No","Yes"))
pdf(file="/Users/gfinak/Documents/manuscripts/MIMOSA_Paper/Figures/volcanoplots.pdf",width=15,height=10)
ggplot(subset(pd,TCELLSUB%in%"cd3+/cd4+"))+geom_point(aes(x=effect,y=Prob.resp,color=response,shape=VISITNO:VACCINE))+facet_wrap(TCELLSUB~CYTOKINE,scale="free_x")+theme(axis.text.x=element_text(angle=90))+scale_color_discrete("Response",labels=c("No","Yes"))
dev.off()
ggplot(subset(pd,TCELLSUB%in%"cd3+/cd4+"))+geom_point(aes(x=effect,y=Prob.resp,color=response,shape=VISITNO:VACCINE))+facet_wrap(TCELLSUB~CYTOKINE,scale="free_x")+theme(axis.text.x=element_text(angle=90))+scale_color_discrete("Response",labels=c("No","Yes"))+theme_bw()
pdf(file="/Users/gfinak/Documents/manuscripts/MIMOSA_Paper/Figures/volcanoplots.pdf",width=15,height=10)
ggplot(subset(pd,TCELLSUB%in%"cd3+/cd4+"))+geom_point(aes(x=effect,y=Prob.resp,color=response,shape=VISITNO:VACCINE))+facet_wrap(TCELLSUB~CYTOKINE,scale="free_x")+theme(axis.text.x=element_text(angle=90))+scale_color_discrete("Response",labels=c("No","Yes"))+theme_bw()
dev.off()
p1<-ggplot(toplot)+geom_tile(aes(x=variable,y=id,fill=value),interpolate=FALSE)+theme_bw()+theme(axis.text.x=element_text(angle=90))+facet_wrap(~stim)+scale_fill_continuous(na.value="gray",breaks=round(seq(0,96,l=10)))
CC
interact.scan
fl.comb
fluidigm<-readFluidigmData()
fluidigm<-processFluidigmData()
fl.bystim<-lapply(fluidigm,exprs)
cd.bystim<-lapply(fluidigm,cData)
fl<-lapply(names(fl.bystim),function(n){
m<-melt(cbind(fl.bystim[[n]],cd.bystim[[n]]),id=c("Stim.Agent","Stim.Condition","Time.of.Stim","Sero.Status","Patient.ID","Chip.Number","Well","Number.of.Cells"))
ddply(m,.(Stim.Condition,Patient.ID,variable),summarize,N=length(value),n=sum(value>0))
})
fl<-lapply(fl,function(x)setnames(x,"variable","Gene"))
Esets.fluidigm<-lapply(fl,function(x)ConstructMIMOSAExpressionSet(x,reference=Stim.Condition%in%"Unstim",measure.columns=c("N","n"),other.annotations=c("Gene","Patient.ID","Stim.Condition"),default.cast.formula=component~Patient.ID+Gene,.variables=.(Patient.ID,Gene),featureCols=1,ref.append.replace="_REF"))
nms<-names(fl.bystim)
Esets.fluidigm<-lapply(1:length(Esets.fluidigm),function(x){pData(Esets.fluidigm[[x]])<-cbind(pData(Esets.fluidigm[[x]]),Stim=nms[x]);Esets.fluidigm[[x]]})
Eset.combined<-combine(Esets.fluidigm[[1]],Esets.fluidigm[[2]],Esets.fluidigm[[3]],Esets.fluidigm[[4]])
fluidigm.fits.by.stim.allgenes<-readRDS("fluidigm.fits.by.stim.allgenes.rds")
fluidigm.fits.by.stim.bygene<-readRDS("fluidigm.fits.by.stim.bygene.rds")
foo<-do.call(rbind,lapply(fluidigm.fits.by.stim.allgenes[[1]],function(x)x@z[,2]))
props<-do.call(rbind,lapply(fluidigm.fits.by.stim.allgenes[[1]],function(x)do.call(c,lapply(x@result@p,function(x)-diff(x[,2])))))
S<-sign(props)
S[S==0]<-1
colnames(S)<-pData(fluidigm.fits.by.stim.allgenes[[1]][[1]])[,c("Patient.ID")]
stim<-pData(fluidigm.fits.by.stim.allgenes[[1]][[1]])$Stim
rownames(S)<-do.call(rbind,lapply(fluidigm.fits.by.stim.allgenes[[1]],function(x)as.character(unique(pData(x)$Gene))))
heatmap.2((S*(foo))[apply(foo,1,function(x)sum(x>0.6)>=1),],col=colorpanel(n=10,high="green",low="red",mid="white"),margins=c(6,5),cexRow=0.5,hclustfun=function(x)hclust(x,method="complete"),trace="none",symbreaks=TRUE,ColSideColors=c("red","orange","yellow","green")[as.numeric(stim)],Colv=TRUE,main="signed Posterior Probabilities\n(fit by gene, all stimulations)")
heatmap.2((S*(foo))[apply(foo,1,function(x)sum(x>0.6)>=1),],col=colorpanel(n=10,high="yellow",low="blue",mid="white"),margins=c(6,5),cexRow=0.5,hclustfun=function(x)hclust(x,method="complete"),trace="none",symbreaks=TRUE,ColSideColors=c("red","orange","yellow","green")[as.numeric(stim)],Colv=TRUE,main="signed Posterior Probabilities\n(fit by gene, all stimulations)")
pdf(file="/Users/gfinak/Documents/manuscripts/MIMOSA_Paper/Figures/FluidigmCombinedFit.pdf")
foo2<-apply(foo,2,function(x)MIMOSA:::fdr(cbind(1-x,x)))
heatmap.2((S*(foo))[apply(foo2,1,function(x)sum(x<0.1)>=1),],col=colorpanel(n=100,high="yellow",low="blue",mid="white"),margins=c(6,5),cexRow=0.75,hclustfun=function(x)hclust(x,method="complete"),trace="none",symbreaks=TRUE,ColSideColors=c("red","orange","yellow","green")[as.numeric(stim)],Colv=TRUE,denscol="black")
dev.off()
colnames(props)<-colnames(S)
rownames(props)<-rownames(S)
heatmap.2(S*sqrt(abs(props)),col=colorpanel(n=10,high="green",low="red",mid="white"),margins=c(6,5),cexRow=0.5,hclustfun=function(x)hclust(x,method="complete"),trace="none",symbreaks=TRUE,ColSideColors=c("red","orange","yellow","green")[as.numeric(stim)],Colv=TRUE,main="Posterior Differences in Proportions\n(fit by gene all stimulations)")
heatmap.2(S*sqrt(abs(props)),col=colorpanel(n=10,high="yellow",low="blue",mid="white"),margins=c(6,5),cexRow=0.5,hclustfun=function(x)hclust(x,method="complete"),trace="none",symbreaks=TRUE,ColSideColors=c("red","orange","yellow","green")[as.numeric(stim)],Colv=TRUE,main="Posterior Differences in Proportions\n(fit by gene all stimulations)")
foo<-do.call(cbind,lapply(fluidigm.fits.by.stim.bygene,function(x)do.call(rbind,lapply(x,function(x)x@z[,2]))))
props<-do.call(cbind,lapply(fluidigm.fits.by.stim.bygene,function(x)do.call(rbind,lapply(x,function(x)do.call(c,lapply(x@result@p,function(x)-diff(x[,2])))))))
S<-sign(props)
colnames(S)<-do.call(c,lapply(fluidigm.fits.by.stim.bygene,function(x)as.character(pData(x[[1]])[,c("Patient.ID")])))
S[S==0]<-1
stim<-as.numeric(factor(do.call(c,lapply(fluidigm.fits.by.stim.bygene,function(x)as.character(pData(x[[1]])$Stim)))))
colnames(S)<-do.call(c,lapply(fluidigm.fits.by.stim.bygene,function(x)as.character(pData(x[[1]])$Patient.ID)))
rownames(S)<-do.call(cbind,lapply(fluidigm.fits.by.stim.bygene[[1]],function(x)as.character(unique(pData(x)$Gene))))
h<-heatmap.2((S*foo)[apply(foo,1,function(x)sum(x>.6)>=1),],col=colorpanel(n=10,high="yellow",low="blue",mid="white"),margins=c(6,5),cexRow=0.5,hclustfun=function(x)hclust(x,method="complete"),trace="none",symbreaks=TRUE,ColSideColors=c("red","orange","yellow","green")[as.numeric(stim)],main="Signed Posterior Probabilities\n(fit by gene and stimulation).")
hmaporder<-h$colInd
geneinds<-apply(foo,1,function(x)sum(x>.6)>=1)
pdf(file="/Users/gfinak/Documents/manuscripts/MIMOSA_Paper/Figures/Fluidigm_plot1.pdf")
foo2<-apply(foo,2,function(x)MIMOSA:::fdr(cbind(1-x,x)))
heatmap.2((S*(foo))[apply(foo2,1,function(x)sum(x<0.1)>=1),],col=colorpanel(n=100,high="yellow",low="blue",mid="white"),margins=c(6,5),cexRow=0.75,hclustfun=function(x)hclust(x,method="complete"),trace="none",symbreaks=TRUE,ColSideColors=c("red","orange","yellow","green")[as.numeric(stim)],Colv=TRUE,denscol="black")
dev.off()
colnames(props)<-colnames(S)
rownames(props)<-rownames(S)
heatmap.2(sqrt(abs(props))*S,col=colorpanel(n=10,high="yellow",low="blue",mid="white"),margins=c(6,5),cexRow=0.5,hclustfun=function(x)hclust(x,method="complete"),trace="none",symbreaks=TRUE,ColSideColors=c("red","orange","yellow","green")[as.numeric(stim)],Colv=TRUE,main="Posterior differences in proportions\n(fit by gene and stimulations)")
fisher<-do.call(rbind,lapply(fluidigm.fits.by.stim.allgenes[[1]],function(x){
p<-vector('numeric',nrow(x@result@n.stim))
for(i in 1:nrow(x@result@n.stim)){
p[i]<-fisher.test(as.matrix(rbind(x@result@n.stim[i,],x@result@n.unstim[i,])),alternative="two.sided")$p.value
}
p
}))
adj.fisher<-matrix(p.adjust(fisher,"fdr"),nrow=96)
S<-sign(lapply(fluidigm.fits.by.stim.allgenes,function(x)do.call(rbind,lapply(x,function(x)(prop.table(as.matrix(x@result@n.stim),1)-prop.table(as.matrix(x@result@n.unstim),1))[,2])))[[1]])
S[S==0]<-1
colnames(fisher)<-gsub("_B3GAT1_Treatment","",colnames(S))
rownames(fisher)<-do.call(rbind,lapply(fluidigm.fits.by.stim.allgenes[[1]],function(x)as.character(unique(pData(x)$Gene))))
stim<-pData(fluidigm.fits.by.stim.allgenes[[1]][[1]])$Stim
heatmap.2(fisher*S,col=colorpanel(n=10,high="yellow",low="blue",mid="white"),margins=c(6,5),cexRow=0.5,hclustfun=function(x)hclust(x,method="complete"),trace="none",symbreaks=TRUE,ColSideColors=c("red","orange","yellow","green")[as.numeric(stim)],Colv=TRUE,main="-log10(p-values)\nfrom Fisher's Exact Test")
pdf(file="/Users/gfinak/Documents/manuscripts/MIMOSA_Paper/Figures/FluidigmFisher.pdf")
colnames(adj.fisher)<-colnames(fisher)
rownames(adj.fisher)<-rownames(fisher)
heatmap.2((((adj.fisher))*S)[apply(adj.fisher,1,function(x)sum(x<0.1)>1),],col=colorpanel(n=100,high="yellow",low="blue",mid="white"),margins=c(6,5),hclustfun=function(x)hclust(x,method="complete"),trace="none",symbreaks=TRUE,ColSideColors=c("red","orange","yellow","green")[as.numeric(stim)],Colv=TRUE,denscol="black")
dev.off()
heatmap.2((((adj.fisher))*S)[apply(adj.fisher,1,function(x)sum(x<0.1)>1),],col=colorpanel(n=100,high="yellow",low="blue",mid="white"),margins=c(6,5),hclustfun=function(x)hclust(x,method="complete"),trace="none",symbreaks=TRUE,ColSideColors=c("red","orange","yellow","green")[as.numeric(stim)],Colv=TRUE,denscol="black")
emprop<-do.call(rbind,lapply(fluidigm.fits.by.stim.allgenes[[1]],function(x){
p<-vector('numeric',nrow(x@result@n.stim))
p<-(prop.table(as.matrix((x@result@n.stim)),1)-prop.table(as.matrix(x@result@n.unstim),1))[,2]
}))
rownames(emprop)<-rownames(fisher)
colnames(emprop)<-colnames(fisher)
heatmap.2(emprop[geneinds,hmaporder],col=colorpanel(n=100,high="yellow",low="blue",mid="white"),margins=c(6,5),Colv=NULL,denscol="black",tracecol="black",symbreaks=TRUE,ColSideColors=c("red","orange","yellow","green")[as.numeric(stim)[hmaporder]])
pdf(file="/Users/gfinak/Documents/manuscripts/MIMOSA_Paper/Figures/FluidigmEmpiricalProps.pdf")
heatmap.2(emprop[geneinds,hmaporder],col=colorpanel(n=100,high="yellow",low="blue",mid="white"),margins=c(6,5),Colv=NULL,denscol="black",tracecol="black",symbreaks=TRUE,ColSideColors=c("red","orange","yellow","green")[as.numeric(stim)[hmaporder]])
dev.off()
fl.comb<-combine(fluidigm[[1]],fluidigm[[2]],fluidigm[[3]],fluidigm[[4]])
melted<-melt(fl.comb)
require(glmnet)
require(Matrix)
melted$Et.bin<-as.numeric(as.logical(melted$Et))
melted<-within(melted,group<-Patient.ID:Stim.Agent)
melted<-cast(melt(melted,id=c("group","Stim.Condition","primerid","wellKey"),measure="Et.bin"),group+Stim.Condition+wellKey~primerid)
g1<-"CCR7";g2<-"GZMK"
gg<-paste(g1,g2,sep=":")
bar<-data.frame(melted[,c("group","Stim.Condition",g1,g2)])
bar$foo<-factor(bar[,c(g1)]):factor(bar[,c(g2)])
setnames(bar,"foo",gg)
C<-cast(melt(bar,id=c("group","Stim.Condition"),measure=c(gg)),group+Stim.Condition~value,fun.aggregate=function(x)length(x))
CC<-list(n.unstim=subset(C,Stim.Condition%in%"Unstim")[,-c(1:2)],n.stim=subset(C,Stim.Condition%in%"Stim")[,-c(1:2)])
toplot<-data.frame(rbind(data.frame(CC$n.stim),data.frame(CC$n.unstim)),stim=c(rep("Stim",nrow(CC$n.stim)),rep("Unstim",nrow(CC$n.unstim))))
toplot$id<-rep(unlist(lapply(strsplit(as.character(subset(C,Stim.Condition%in%"Unstim")[,1]),":"),function(x)x[1]),use.names=FALSE),2)
colnames(toplot)[1:4]<-gsub("X","",paste(g1,g2,colnames(toplot)[1:4],sep=":"))
toplot<-melt(toplot,id=c("id","stim"))
p1<-ggplot(toplot)+geom_tile(aes(x=variable,y=id,fill=value),interpolate=FALSE)+theme_bw()+theme(axis.text.x=element_text(angle=90))+facet_wrap(~stim)+scale_fill_continuous(na.value="gray",breaks=round(seq(0,96,l=10)))
DD<-CC
DD[[1]]<-cbind(CC[[1]][,1],rowSums(CC[[1]][,2:4]))
DD[[2]]<-cbind(CC[[2]][,1],rowSums(CC[[2]][,2:4]))
toplot2<-data.frame(rbind(data.frame(DD$n.stim),data.frame(DD$n.unstim)),stim=c(rep("Stim",nrow(DD$n.stim)),rep("Unstim",nrow(DD$n.unstim))))
toplot2$id<-rep(unlist(lapply(strsplit(as.character(subset(C,Stim.Condition%in%"Unstim")[,1]),":"),function(x)x[1]),use.names=FALSE),2)
colnames(toplot2)[1:2]<-gsub("X","",paste(g1,g2,colnames(toplot2)[1:2],sep=":"))
toplot2<-melt(toplot2,id=c("id","stim"))
p2<-ggplot(toplot2)+geom_tile(aes(x=variable,y=id,fill=value),interpolate=FALSE)+theme_bw()+theme(axis.text.x=element_text(angle=90))+facet_wrap(~stim)+scale_fill_continuous(na.value="gray",breaks=round(seq(0,96,l=10)))
p1
p2
p1<-ggplot(toplot)+geom_tile(aes(x=variable,y=id,fill=log2(value)),interpolate=FALSE)+theme_bw()+theme(axis.text.x=element_text(angle=90))+facet_wrap(~stim)+scale_fill_continuous(na.value="gray",breaks=round(seq(0,96,l=10)))
p2<-ggplot(toplot2)+geom_tile(aes(x=variable,y=id,fill=log2(value)),interpolate=FALSE)+theme_bw()+theme(axis.text.x=element_text(angle=90))+facet_wrap(~stim)+scale_fill_continuous(na.value="gray",breaks=round(seq(0,96,l=10)))
p1
p2
p1
p1<-ggplot(toplot)+geom_tile(aes(x=variable,y=id,fill=log2(value)),interpolate=FALSE)+theme_bw()+theme(axis.text.x=element_text(angle=90))+facet_wrap(~stim)+scale_fill_continuous(na.value="gray")
p1
p2<-ggplot(toplot2)+geom_tile(aes(x=variable,y=id,fill=log2(value)),interpolate=FALSE)+theme_bw()+theme(axis.text.x=element_text(angle=90))+facet_wrap(~stim)+scale_fill_continuous(na.value="gray")
p2
flres<-.fitMCMC(data=CC,inits=MIMOSA:::MDMix(CC,initonly=TRUE),EXPRATE=1e-2,pXi=1,alternative="not equal")
flsum<-.fitMCMC(data=DD,inits=MIMOSA:::MDMix(DD,initonly=TRUE),EXPRATE=1e-2,pXi=1,alternative="not equal")
sapply(list.files(pattern=c("\\.dat")),unlink)
missed<-!MIMOSA:::fdr(flres$z)<0.05
toplot$variable<-factor(toplot$variable,labels=c("CCR7-GZMK-","CCR7-GZMK+","CCR7+GZMK-","CCR7+GZMK+"))
toplot2$variable<-factor(toplot2$variable,labels=c("CCR7-GZMK-","CCR7+ or GZMK+"))
p1<-ggplot(toplot)+geom_tile(aes(x=variable,y=id,fill=log2(value)),interpolate=FALSE)+theme_bw()+theme(axis.text.x=element_text(angle=90))+facet_wrap(~stim)+scale_fill_continuous(na.value="gray",breaks=round(seq(0,96,l=10)))+theme(axis.text.y=element_text(color=c("black","red")[missed+1]))
p2<-ggplot(toplot2)+geom_tile(aes(x=variable,y=id,fill=log2(value)),interpolate=FALSE)+theme_bw()+theme(axis.text.x=element_text(angle=90,hjust=1))+facet_wrap(~stim)+scale_fill_continuous(na.value="gray",breaks=round(seq(0,96,l=10)))+theme(axis.text.y=element_text(color=c("black","red")[2]))
p1
p2
p1<-ggplot(toplot)+geom_tile(aes(x=variable,y=id,fill=log2(value)),interpolate=FALSE)+theme_bw()+theme(axis.text.x=element_text(angle=90))+facet_wrap(~stim)+scale_fill_continuous(na.value="gray",breaks=round(seq(0,6,l=10)))+theme(axis.text.y=element_text(color=c("black","red")[missed+1]))
p2<-ggplot(toplot2)+geom_tile(aes(x=variable,y=id,fill=log2(value)),interpolate=FALSE)+theme_bw()+theme(axis.text.x=element_text(angle=90,hjust=1))+facet_wrap(~stim)+scale_fill_continuous(na.value="gray",breaks=round(seq(0,6,l=10)))+theme(axis.text.y=element_text(color=c("black","red")[2]))
p1
p2
p1<-ggplot(toplot)+geom_tile(aes(x=variable,y=id,fill=log2(value)),interpolate=FALSE)+theme_bw()+theme(axis.text.x=element_text(angle=90))+facet_wrap(~stim)+scale_fill_continuous("log2 count",na.value="gray",breaks=round(seq(0,6,l=10)))+theme(axis.text.y=element_text(color=c("black","red")[missed+1]))
p2<-ggplot(toplot2)+geom_tile(aes(x=variable,y=id,fill=log2(value)),interpolate=FALSE)+theme_bw()+theme(axis.text.x=element_text(angle=90,hjust=1))+facet_wrap(~stim)+scale_fill_continuous("log2 count",na.value="gray",breaks=round(seq(0,6,l=10)))+theme(axis.text.y=element_text(color=c("black","red")[2]))
p1
p2
p1
grid.arrange(p1,ncol=1)
library(gridExtra)
grid.arrange(p1,ncol=1)
pdf(file="/Users/gfinak/Documents/manuscripts/MIMOSA_Paper/Figures/revised_Fluidigm_Multivariate_CCR7_GZMK.pdf",width=6,height=4)
grid.arrange(p1,ncol=1)
dev.off()
grid.arrange(p2,ncol=1)
pdf(file="/Users/gfinak/Documents/manuscripts/MIMOSA_Paper/Figures/revised_Fluidigm_Marginal_CCR7_GZMK.pdf",width=6,height=4)
grid.arrange(p2,ncol=1)
dev.off()
rocplots
f1levs
levs
f1levs<-levs[c(8,11,13,17,15,16,10)]
sflevs<-setdiff(levs,f1levs)
AUC$y[AUC$Method%in%"Fisher"]<-0.4
AUC$y[AUC$Method%in%"MIMOSA (EM)"]<-0.5
AUC$y[AUC$Method%in%"MIMOSA (MCMC)"]<-0.3
fnames<-c("revised_2.pdf","revised_1.pdf","revised_15.pdf","revised_3.pdf","revised_5.pdf","revised_6.pdf","revised_7.pdf")
rocplots<-ggplot(subset(ROC,TCELLSUB%in%"cd3+/cd4+"))+geom_line(aes(x=FPR,y=TPR,color=Method))+theme_bw()+facet_wrap(~CYTOKINE)+geom_text(aes(x=x,y=y,label=sprintf("AUC=%s",signif(AUC,2)),col=Method),size=3,data=AUC,show_guide=FALSE)+theme(axis.text.x=element_text(angle=90,hjust=1))
fdrplots<-ggplot(subset(FDR,TCELLSUB%in%c("cd3+/cd4+")))+geom_line(aes(y=true.fdr,x=fdr,color=Method))+geom_abline(1,lty=3)+theme_bw()+scale_x_continuous(name="Nominal FDR")+scale_y_continuous(name="Observed FDR")+facet_wrap(~CYTOKINE)+theme(axis.text.x=element_text(angle=90,hjust=1))
rocplots
f1levs
levs
f1levs<-levs[c(8,11,13,17,15,16,10,7)]
sflevs<-setdiff(levs,f1levs)
i
length(f1levs)
i<-8
fi.1<-ggplot(subset(ROC,TCELLSUB%in%"cd3+/cd4+"&CYTOKINE%in%f1levs[i]))+geom_line(aes(x=FPR,y=TPR,color=Method))+theme_bw()+facet_wrap(~CYTOKINE)+geom_text(aes(x=x,y=y,label=sprintf("AUC=%s",signif(AUC,2)),col=factor(Method)),data=subset(AUC,CYTOKINE%in%f1levs[i]),show_guide=FALSE)+theme(axis.text.x=element_text(angle=90,hjust=1))
fi.2<-ggplot(subset(FDR,TCELLSUB%in%c("cd3+/cd4+")&CYTOKINE%in%f1levs[i]))+geom_line(aes(y=true.fdr,x=fdr,color=Method))+geom_abline(1,lty=3)+theme_bw()+scale_x_continuous(name="Nominal FDR")+scale_y_continuous(name="Observed FDR")+facet_wrap(~CYTOKINE)+theme(axis.text.x=element_text(angle=90,hjust=1))
fi.1
fi.2
pdf(file=sprintf("/Users/gfinak/Documents/manuscripts/MIMOSA_Paper/Figures/%s",fnames[i]),width=10,height=3)
grid.arrange(fi.1,fi.2,ncol=2,nrow=1)
dev.off()
fnames
fnames<-c("revised_2.pdf","revised_1.pdf","revised_15.pdf","revised_3.pdf","revised_5.pdf","revised_6.pdf","revised_7.pdf","revised_8.pdf")
fi.1<-ggplot(subset(ROC,TCELLSUB%in%"cd3+/cd4+"&CYTOKINE%in%f1levs[i]))+geom_line(aes(x=FPR,y=TPR,color=Method))+theme_bw()+facet_wrap(~CYTOKINE)+geom_text(aes(x=x,y=y,label=sprintf("AUC=%s",signif(AUC,2)),col=factor(Method)),data=subset(AUC,CYTOKINE%in%f1levs[i]),show_guide=FALSE)+theme(axis.text.x=element_text(angle=90,hjust=1))
fi.2<-ggplot(subset(FDR,TCELLSUB%in%c("cd3+/cd4+")&CYTOKINE%in%f1levs[i]))+geom_line(aes(y=true.fdr,x=fdr,color=Method))+geom_abline(1,lty=3)+theme_bw()+scale_x_continuous(name="Nominal FDR")+scale_y_continuous(name="Observed FDR")+facet_wrap(~CYTOKINE)+theme(axis.text.x=element_text(angle=90,hjust=1))
pdf(file=sprintf("/Users/gfinak/Documents/manuscripts/MIMOSA_Paper/Figures/%s",fnames[i]),width=10,height=3)
grid.arrange(fi.1,fi.2,ncol=2,nrow=1)
dev.off()
glm.train
install.packages("knitr")
library(knitr)
